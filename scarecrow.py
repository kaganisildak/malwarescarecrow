import ctypes, os,sys, shutil
from winreg import *
import curio
from colorit import *
import time
import win32pipe, win32file, pywintypes
import subprocess
import signal

f = curio.TaskGroup()
created_process = []
init_colorit()

def print_log(log):
    print(color("[OK] ",Colors.green),end=log+"\n")

def signal_handler(sig, frame):
    global created_process
    for proc in created_process:
        proc.kill()
    print_log("FINISHED")
    sys.exit(0)

def check_privilege():
    return ctypes.windll.shell32.IsUserAnAdmin() != 0

def start_fake_process(pname):
    global created_process
    pathname = os.path.dirname(sys.argv[0])     
    shutil.copyfile(pathname+"\\fake.exe",pathname+"\\"+pname)
    DETACHED_PROCESS = 0x00000008
    proc = subprocess.Popen(pathname+"\\"+pname,shell=False,stdin=None,stdout=None,stderr=None,close_fds=True,creationflags=DETACHED_PROCESS)
    created_process.append(proc)

async def pipe_server(name):
    count = 0
    pipe = win32pipe.CreateNamedPipe(
        name,
        win32pipe.PIPE_ACCESS_DUPLEX,
        win32pipe.PIPE_TYPE_MESSAGE | win32pipe.PIPE_READMODE_MESSAGE | win32pipe.PIPE_WAIT,
        1, 65536, 65536,
        0,
        None)
    win32pipe.ConnectNamedPipe(pipe, None)

async def setup_sc():
    CreateKey(HKEY_CURRENT_USER,"SOFTWARE\\Wine")

    reg_keys = ["SOFTWARE\\Oracle\\VirtualBox Guest Additions","HARDWARE\\ACPI\\DSDT\\VBOX__","HARDWARE\\ACPI\\FADT\\VBOX__",
    "HARDWARE\\ACPI\\RSDT\\VBOX__","SYSTEM\\ControlSet001\\Services\\VBoxGuest","SYSTEM\\ControlSet001\\Services\\VBoxMouse",
    "SYSTEM\\ControlSet001\\Services\\VBoxService","SYSTEM\\ControlSet001\\Services\\VBoxSF","SYSTEM\\ControlSet001\\Services\\VBoxVideo",
    "SOFTWARE\\VMware, Inc.\\VMware Tools"]
    for i in reg_keys:
        CreateKey(HKEY_LOCAL_MACHINE,i)
        print_log("Creating fake registry key : " + i)

    filelist = ["C:\\WINDOWS\\system32\\drivers\\VBoxMouse.sys","C:\\WINDOWS\\system32\\drivers\\VBoxGuest.sys",
    "C:\\WINDOWS\\system32\\drivers\\VBoxSF.sys","C:\\WINDOWS\\system32\\drivers\\VBoxVideo.sys","C:\\WINDOWS\\system32\\vboxdisp.dll",
    "C:\\WINDOWS\\system32\\vboxhook.dll","C:\\WINDOWS\\system32\\vboxmrxnp.dll","C:\\WINDOWS\\system32\\vboxogl.dll","C:\\WINDOWS\\system32\\vboxoglarrayspu.dll",
    "C:\\WINDOWS\\system32\\vboxoglcrutil.dll","C:\\WINDOWS\\system32\\vboxoglerrorspu.dll","C:\\WINDOWS\\system32\\vboxoglfeedbackspu.dll","C:\\WINDOWS\\system32\\vboxoglpackspu.dll",
    "C:\\WINDOWS\\system32\\vboxoglpassthroughspu.dll","C:\\WINDOWS\\system32\\vboxservice.exe","C:\\WINDOWS\\system32\\vboxtray.exe","C:\\WINDOWS\\system32\\VBoxControl.exe",
    "C:\\WINDOWS\\system32\\drivers\\vmmouse.sys","C:\\WINDOWS\\system32\\drivers\\vmhgfs.sys","C:\\WINDOWS\\system32\\drivers\\vmusbmouse.sys",
    "C:\\WINDOWS\\system32\\drivers\\vmkdb.sys","C:\\WINDOWS\\system32\\drivers\\vmrawdsk.sys","C:\\WINDOWS\\system32\\drivers\\vmmemctl.sys",
    "C:\\WINDOWS\\system32\\drivers\\vm3dmp.sys"]
    
    os.makedirs("C:\\program files\\oracle\\virtualbox guest additions\\",exist_ok=True)
    for i in filelist:
        print_log("Creating fake file : "+i)
        open(i,"w")

    processlist = ["vboxservices.exe","vboxservice.exe","vboxtray.exe","xenservice.exe","VMSrvc.exe","VMUSrvc.exe","qemu-ga.exe","prl_cc.exe","prl_tools.exe"]

    for i in processlist:
        start_fake_process(i)
        print_log("Starting fake process : " + i)
    await pipe_server(r'\\.\pipe\VBoxMiniRdDN')
    await pipe_server(r'\\.\pipe\VBoxTrayIPC')
async def main(): 
    if check_privilege() == False:

        print("Please run with Admin privilege")
        print_log("test")
        sys.exit(0)
    await setup_sc()

if __name__ == '__main__':
    signal.signal(signal.SIGINT, signal_handler)
    signal.signal(signal.SIGABRT, signal_handler)
    curio.run(main)
    input()